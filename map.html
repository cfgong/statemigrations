<!DOCTYPE html>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<style>
h1 {
  font-family:arial;
  font-size:2em;
  color:#333;
}
#info {
  position:absolute;
  top: 10px;
  left: 10px;
}
.states {
	fill: #e5e5e5;
	stroke: #fff;
	stroke-width:2px;
}
.states:hover {
	fill: steelblue;
}
.arcs {
  stroke-width: 2px;
  stroke: tomato;
  pointer-events: none;
  fill: none;
}
</style>
<body>
<div id="info"><h1 id="name"></h1></div>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script>

var width = 960,
	height = 500;

var svg = d3.select('body').append('svg')
	.attr('width', width)
	.attr('height', height);


var projection = d3.geo.albersUsa()
	.scale(1000)
	.translate([width / 2, height / 2]);

var path = d3.geo.path()
	.projection(projection);

var arcdata = [
      {
        leaving: "California",
        to: "Illinois",
        sourceLocation: [-99.5606025, 41.068178502813595],
        targetLocation: [-106.503961875, 33.051502817366334]
        },
      {
        leaving: "Colorado",
        to: "Kansas",
        sourceLocation: [-99.5606025, 41.068178502813595],
        targetLocation: [-97.27544625, 34.29490081496779]
    }
]

var California = [
      {
        leaving: "California",
        to: "Texas",
        sourceLocation: [-119.355165,35.458606],
        targetLocation: [-97.388631,30.943149]
      }
]

var Washington = [
      {
        leaving: "Washington",
        to: "California",
        sourceLocation: [-121.624501,47.341728],
        targetLocation: [-119.355165,35.458606]
      }
]

d3.json('states.json', function(error, us) {
	svg.selectAll('.states')
		.data(topojson.feature(us, us.objects.usStates).features)
		.enter()
		.append('path')
		.attr('class', 'states')
		.attr('d', path)
		.on('mouseover', function(d){
			var name = d.properties.STATE_ABBR;
			return drawArcs(name);
		})
    .on('mouseout', function(d){
      var name = d.properties.STATE_ABBR;
      var svg_id = "#" + name;
      d3.select(svg_id).remove();
    });
    /*
  svg = svg.append("g")
             .attr("class","arcs");
  svg.selectAll('.arcs')
    .data(arcdata)
    .enter()
    .append('path')
    .attr('d', function(d) {
          return lngLatToArc(d, 'sourceLocation', 'targetLocation', 15);
    });
  */
    function drawArcs(state) {
      svg = svg.append("g")
               .attr("class", "arcs");
      svg.selectAll('.arcs')
         .data(window[state])
         .enter()
         .append('path')
         .attr('id', state)
         .attr('d', function(d) {
               return lngLatToArc(d, 'sourceLocation', 'targetLocation', 15);
         });
    }
});



function lngLatToArc(d, sourceName, targetName, bend){
      // If no bend is supplied, then do the plain square root
      bend = bend || 1;
      // `d[sourceName]` and `d[targetname]` are arrays of `[lng, lat]`
      // Note, people often put these in lat then lng, but mathematically we want x then y which is `lng,lat`

      var sourceLngLat = d[sourceName],
          targetLngLat = d[targetName];

      if (targetLngLat && sourceLngLat) {
        var sourceXY = projection( sourceLngLat ),
            targetXY = projection( targetLngLat );

        // Uncomment this for testing, useful to see if you have any null lng/lat values
        // if (!targetXY) console.log(d, targetLngLat, targetXY)
        var sourceX = sourceXY[0],
            sourceY = sourceXY[1];

        var targetX = targetXY[0],
            targetY = targetXY[1];

        var dx = targetX - sourceX,
            dy = targetY - sourceY,
            dr = Math.sqrt(dx * dx + dy * dy)*bend;

        // To avoid a whirlpool effect, make the bend direction consistent regardless of whether the source is east or west of the target
        var west_of_source = (targetX - sourceX) < 0;
        if (west_of_source) return "M" + targetX + "," + targetY + "A" + dr + "," + dr + " 0 0,1 " + sourceX + "," + sourceY;
        return "M" + sourceX + "," + sourceY + "A" + dr + "," + dr + " 0 0,1 " + targetX + "," + targetY;

      } else {
        return "M0,0,l0,0z";
      }
}


</script>
</body>
</html>
